---
title: "Data storytelling"
author: "Ricardo Mayer"
date: "08-05-2021"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

library(tidyverse)
library(lubridate)
library(grid)
library(gridExtra)
library(gridtext)
library(lemon)
library(stringr)

source("include.R")
source("theme/theme_swd.R")


```

## Qué es data storytelling?

**Uso de técnicas narrativas para comunicar datos**

+ Técnicas narrativas:

  - Establece tu audiencia
  - Establece tu objetivo
  - Crea un arco narrativo
  - Consigue, concentra y mantiene su atención
  
+ Comunicación de datos

  - Documentar datos o establecer un punto?
  - Elije el nivel de detalle
  - La forma sigue a la función
  - Documento para presentar o apoyo a una presentación?
  

## Necesito data storytelling?

Baja necesidad:

 + Quiero consultar mis tablas de datos, pero en forma de gráficos
 
 + Análisis exploratorio de consumo personal e inmediato
 
 + Quiero traspasar a otro mis datos, en forma de gráficos
 
 + Audiencia quiere "auditar" tus datos
 

Necesidad media: 

 + Audiencia cautiva, datos rutinarios, estándares establecidos
 
 + Audiencia experta en estos datos
 
 + Yo, en el futuro.
 
 + El lector quiere un examen preliminar
 
 
Alta necesidad

 + Necesito capturar la atención
 
 + Necesito motivar al lector a hacer algo
 
 + Audiencia con poca experiencia leyendo estos datos
 
 + Audiencia quiere escuchar sólo The Big Idea
 
 
## Ejemplo 1: tickets, before


```{r tickets-data, include=FALSE}
df_t <- read_csv(file.path("data","FIG0410-14.csv")) %>% rename(ticket_type = X1) %>%
  mutate(ticket_type = forcats::fct_rev(factor(case_when(ticket_type == "Ticket Volume Received" ~ "Received",
                                 ticket_type == "Ticket Volume Processed" ~ "Processed")))) %>%
  pivot_longer(cols = !ticket_type, names_to = "month", values_to = "tickets") %>%
  mutate(date = lubridate::ymd(paste0("2000-",match(month,month.abb),"-01"))) 

```


```{r tickets-before-code, include=FALSE}

df_t %>% ggplot(aes(x = date, y = tickets, color = ticket_type)) + 
  geom_line() + 
  geom_point(aes(shape = ticket_type)) + 
  theme_minimal() + 
  theme(legend.position = "bottom")
  


```


## Ejemplo 1: tickets, after

```{r tickets-after-code, include=FALSE, cache=TRUE}
theme_set(theme_minimal() +  theme(panel.grid.major = element_blank(),
                                  panel.grid.minor = element_blank(),
                                  axis.line = element_line(color = GRAY9),
                                  axis.title.y = element_text(color = GRAY8, hjust = 1),
                                  axis.title.x = element_text(color = GRAY8, hjust = 0),
                                  axis.ticks = element_line(color = GRAY9),
                                  axis.text = element_text(color = GRAY8, size = 12),
                                  plot.margin = unit(c(1,4,1,1), "cm"),
                                  plot.title = element_text(size = 18),
                                  plot.caption = element_text(color = GRAY8, hjust = 0, margin = margin(.3,0,0,0,"cm"))
                                  ))

# df <- read_csv(file.path("data","FIG0410-14.csv")) %>% rename(ticket_type = X1) %>%
#   mutate(ticket_type = forcats::fct_rev(factor(case_when(ticket_type == "Ticket Volume Received" ~ "Received",
#                                  ticket_type == "Ticket Volume Processed" ~ "Processed")))) %>%
#   pivot_longer(cols = !ticket_type, names_to = "month", values_to = "tickets") %>%
#   mutate(date = lubridate::ymd(paste0("2000-",match(month,month.abb),"-01"))) 

grob_explanation <- grobTree(richtext_grob(
  "<span style='background-color:white'><b>2 employees quit in May.</b> We nearly kept up with<br>incoming volume in the following two months, but fell<br>behind with the increase in Aug and haven't been able<br>to catch up since</span>", 
  x=.35,  y=.9, hjust=0, gp=gpar(col = GRAY3, fontsize=11), box_gp = gpar(col = "white", fill = "white"),
  padding = margin(.4,0,0,0,"in")))

pt1 <- ggplot(df_t) + geom_line(aes(x = date, y = tickets, color = ticket_type),size = 2) + 
  geom_point(aes(x = date, y = tickets, color = ticket_type),size = 4,data = df_t %>% filter(date >= ymd("2000-08-01"))) +
  geom_text(aes(x = date, y = tickets, color = ticket_type, label = tickets), nudge_y = 15, size = 4, data = df_t %>% filter(date >= ymd("2000-08-01"), ticket_type == "Received")) +
  geom_text(aes(x = date, y = tickets, color = ticket_type, label = tickets), nudge_y = -15, size = 4, data = df_t %>% filter(date >= ymd("2000-08-01"), ticket_type == "Processed")) +
  geom_text(aes(x = date, y = tickets, color = ticket_type, label = ticket_type), nudge_x = 5, hjust = 0, size = 5, data = df_t %>% filter(month == "Dec")) + 
  geom_vline(xintercept = ymd("2000-05-01"), color = GRAY8) + 
  scale_x_date(date_labels = "%b", date_breaks = "1 month", expand = c(0,0)) + 
  scale_y_continuous(breaks = seq(0,300,50), limits = c(0,300)) + 
  scale_color_manual(values = c("Received" = GRAY7, "Processed" = BLUE1), guide = NULL) + 
  coord_cartesian(clip = "off") + 
  labs(title = "Ticket volume over time", 
       caption = "Data source: XYZ Dashboard, as of 12/31/2014 | A detailed analysis on tickets processed per\nperson and time to resolve issues was undertaken to inform this request and can be provided.",
       x = "2014",
       y = "Number of tickets") +
  annotation_custom(grob_explanation)
 
# height <- 5.5
# width <- 8
# dev.new(width = width, height = height, units = "in", noRStudioGD = T)

```


```{r tickets-after, echo=FALSE}
print(pt1)
```



## Ejemplo 2: la competencia: before

```{r la-competencia-data, include=FALSE}
df_c <- read_csv(file.path("data", "FIG0820.csv")) %>%
  pivot_longer(cols = -product, names_to = "year", values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(value = as.numeric(str_remove(value,"\\$"))) %>%
  mutate(product_letter = str_sub(product, str_length(product),str_length(product)))


```



```{r la-competencia-code-before, include=FALSE}
pt_2_bf <- df_c %>% ggplot(aes(x = product, y = value)) + 
  geom_col(aes(fill = year), position = "dodge") +
  scale_y_continuous(labels = scales::dollar_format()) + 
  theme_minimal() + 
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank()) + 
  labs(title = "Average Retail Product Price Per Year",
       caption = "Price has declined for all products on the market since introduction of product C in 2010") 



```


```{r la-competencia-before, echo=FALSE}

print(pt_2_bf)

```


## Ejemplo 2: la competencia: after

```{r la-compentecia-after-data}
df_2014_avg <- df_c %>% filter(year == "2014") %>% group_by(year) %>% summarise(value = mean(value))

df_product_labels <- df_c %>% group_by(product_letter) %>% mutate(value = if_else(year == min(as.numeric(year)), value,  0)) %>% summarise(year = as.character(min(as.numeric(year))), value = sum(value))

```


```{r la-competencia-after-code, include=FALSE, cache=TRUE}

theme_set(theme_swd() + theme(
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.title = element_text(color = GRAY6),
  axis.title.x = element_text(hjust = .1),
  axis.text.y = element_text(color = c(GRAY6,BLUE1,BLUE1,GRAY6,GRAY6,GRAY6))
))


grob_recommended = grobTree(textGrob("Recommended", x = .015, y = .372, hjust = 0, gp = gpar(col = BLUE1)))

pt2 <- df_c %>% ggplot(aes(x = year, y = value, group = product)) +
  geom_rect(data = df_c %>% head(1),xmin = -Inf, xmax = "2014", ymin = 150, ymax = 200, fill = GRAY9, alpha = .5) +
  geom_line(size = 1.2, color = GRAY6) + 
  geom_point(data = df_2014_avg, aes(group = NA), size = 2, color = BLUE1) + 
  geom_text(data = df_product_labels, 
            aes(label = product_letter, group = NA),
            nudge_x = -.1, color = GRAY6, size = 3.5) +
  geom_text(data = df_2014_avg, aes(group = NA, label = "AVG"), 
            color = BLUE1, nudge_x = -.3, size = 3, nudge_y = 10) +
  scale_y_continuous(breaks = c(0,150,200,300,400,500), 
                     limits = c(0,500),
                     labels = scales::number_format(prefix = "$")) + 
  scale_x_discrete(expand = c(.15,0, .05, 0)) + 
  labs(title = "Retail price over time",
       y = "Average price",
       x = "Year") + 
  annotation_custom(grob_recommended)
 
# width <- 6.5
# height <- 4
# dev.new(width = width, height = height, noRStudioGD = T)


```


```{r la-competencia-after, message=FALSE, warning=FALSE}
print(pt2)

```





 
